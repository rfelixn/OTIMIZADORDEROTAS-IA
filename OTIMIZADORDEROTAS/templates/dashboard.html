<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OTIMIZADORDEROTAS-IA - Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { background: #0f1724; color: #e6eef8; }
    .card { background: rgba(255,255,255,0.04); border: none; }
    .btn-primary { background: #0ea5e9; border: none; }
    #map{height:74vh; border-radius:8px; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">OTIMIZADORDEROTAS-IA</a>
    <div class="text-light">
      Usuário: {{ current_user.username }} | 
      <a href="{{ url_for('logout') }}" class="text-light">Sair</a>
    </div>
  </div>
</nav>

<div class="container-fluid mt-3">
  <div class="row">
    <div class="col-lg-4">
      <div class="card mb-3 p-3">
        <h5>Nova entrega</h5>
        <form method="post" action="{{ url_for('nova_entrega') }}">
          <input name="address" class="form-control mb-2" placeholder="Endereço (ex: R. Exemplo, 100)" required>
          <input name="city" class="form-control mb-2" placeholder="Cidade (opcional)">
          <input name="notes" class="form-control mb-2" placeholder="Notas (opcional)">
          <button class="btn btn-success w-100">Adicionar</button>
        </form>

        <hr class="my-2">
        <h6>Entregas</h6>
        <ul class="list-group" id="list-deliveries">
          {% for d in deliveries %}
            <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent text-light">
              <div>
                <b>#{{ d.id }}</b> {{ d.address }}{% if d.city %}, {{ d.city }}{% endif %}
                <div><small>{{ d.notes }}</small></div>
              </div>
              <div class="btn-group">
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('open_waze', id=d.id) }}" target="_blank">Waze</a>
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('open_maps', id=d.id) }}" target="_blank">Maps</a>
                {% if not d.lat %}
                  <button class="btn btn-sm btn-outline-info js-geocode" data-id="{{ d.id }}">Geocode</button>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>

        <hr class="my-2">
        <h6>Otimizar rota</h6>
        <input id="startLat" class="form-control mb-2" placeholder="Lat início (ex: 38.7223)">
        <input id="startLon" class="form-control mb-2" placeholder="Lon início (ex: -9.1393)">
        <input id="ids" class="form-control mb-2" placeholder="IDs separadas por vírgula (ex: 1,2,3)">
        <button id="btn-opt" class="btn btn-info w-100">Otimizar</button>
        <div id="opt-result" class="mt-2"></div>

        <a href="{{ url_for('export_pdf') }}" class="btn btn-outline-light w-100 mt-2">Exportar relatório (PDF)</a>
      </div>
    </div>

    <div class="col-lg-8">
      <div id="map"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const deliveries = {{ deliveries|tojson }};
  const map = L.map('map').setView([38.7223, -9.1393], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

  const markers = {};
  deliveries.forEach(d=>{
    if (d.lat && d.lon){
      const m = L.marker([d.lat,d.lon]).addTo(map).bindPopup(`<b>#${d.id}</b><br>${d.address}`);
      markers[d.id]=m;
    }
  });

  // Geocode
  document.querySelectorAll('.js-geocode').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.dataset.id;
      btn.disabled = true; btn.innerText='...';
      const res = await fetch(`/geocode/${id}`,{method:'POST'});
      const j = await res.json();
      if (j.ok) location.reload(); else {alert('Geocode falhou'); location.reload();}
    });
  });

  // Otimização de rota
  document.getElementById('btn-opt').addEventListener('click', async ()=>{
    const lat = parseFloat(document.getElementById('startLat').value);
    const lon = parseFloat(document.getElementById('startLon').value);
    const ids = document.getElementById('ids').value.split(',').map(x=>x.trim()).filter(x=>x).map(Number);
    const res = await fetch('/api/optimize',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({start:{lat,lon}, ids})
    });
    const j = await res.json();
    if (j.order) document.getElementById('opt-result').innerText = 'Ordem: ' + j.order.join(', ');
    else document.getElementById('opt-result').innerText = JSON.stringify(j);
  });
</script>
</body>
</html>
